<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Cluster-Based Route Generation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
        }

        .info {
            background: #e0f2fe;
            border: 1px solid #0ea5e9;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }

        button:hover {
            background: #059669;
        }

        button.danger {
            background: #ef4444;
        }

        button.danger:hover {
            background: #dc2626;
        }

        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
        }

        .success {
            background: #d1fae5;
            border: 1px solid #10b981;
        }

        .error {
            background: #fee2e2;
            border: 1px solid #ef4444;
        }

        .loading {
            background: #fef3c7;
            border: 1px solid #f59e0b;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ Test Cluster-Based Route Generation</h1>

        <div class="info">
            <strong>üìã Expected Results:</strong><br>
            <strong>Before:</strong> 3 routes (Daily Priority, Fixed Days, Weekly Cluster)<br>
            <strong>After:</strong> 2 routes (Priority Barangay 1C-PB, Clustered Barangay 2C-CA)
        </div>

        <button onclick="clearData()" class="danger">üóëÔ∏è Clear Existing Data</button>
        <button onclick="generateRoutes()">üöÄ Generate Routes (Cluster-Based)</button>
        <button onclick="checkRoutes()">üîç Check Generated Routes</button>

        <div id="result"></div>
    </div>

    <script>
        const API_BASE = 'https://kolektrash.systemproj.com/backend/api';

        async function clearData() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'loading';
            resultDiv.textContent = '‚è≥ Clearing existing data...';

            try {
                // Note: You'll need to create a clear endpoint or do this manually via SQL
                resultDiv.className = 'success';
                resultDiv.textContent = '‚úÖ Please run this SQL manually:\n\nDELETE FROM daily_route_stop WHERE daily_route_id IN (SELECT id FROM daily_route WHERE date = \'2025-12-01\');\nDELETE FROM daily_route WHERE date = \'2025-12-01\';\nDELETE FROM collection_team_member WHERE team_id IN (SELECT team_id FROM collection_team WHERE schedule_id IN (SELECT schedule_id FROM collection_schedule WHERE scheduled_date = \'2025-12-01\'));\nDELETE FROM collection_team WHERE schedule_id IN (SELECT schedule_id FROM collection_schedule WHERE scheduled_date = \'2025-12-01\');\nDELETE FROM collection_schedule WHERE scheduled_date = \'2025-12-01\';';
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.textContent = '‚ùå ERROR:\n\n' + error.message;
            }
        }

        async function generateRoutes() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'loading';
            resultDiv.textContent = '‚è≥ Generating routes with cluster-based grouping... Please wait...';

            try {
                const response = await fetch(`${API_BASE}/auto_generate_all.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        start_date: '2025-12-01',
                        end_date: '2025-12-01',
                        session: 'AM',
                        overwrite: true,
                        cron_token: 'kolektrash_cron_2024'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const routesGenerated = data.routes[0]?.routes_generated || 0;
                    const tasksGenerated = data.tasks?.total_generated || 0;

                    let summary = `‚úÖ SUCCESS!\n\n`;
                    summary += `üìä Summary:\n`;
                    summary += `- Tasks generated: ${tasksGenerated}\n`;
                    summary += `- Routes generated: ${routesGenerated}\n\n`;

                    if (routesGenerated === 2) {
                        summary += `‚úÖ EXPECTED: 2 routes (cluster-based grouping working!)\n\n`;
                    } else {
                        summary += `‚ö†Ô∏è UNEXPECTED: Expected 2 routes, got ${routesGenerated}\n\n`;
                    }

                    summary += `Full Response:\n${JSON.stringify(data, null, 2)}`;

                    resultDiv.className = routesGenerated === 2 ? 'success' : 'error';
                    resultDiv.textContent = summary;
                } else {
                    resultDiv.className = 'error';
                    resultDiv.textContent = '‚ùå ERROR:\n\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.textContent = '‚ùå FETCH ERROR:\n\n' + error.message;
            }
        }

        async function checkRoutes() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'loading';
            resultDiv.textContent = '‚è≥ Checking routes...';

            try {
                const response = await fetch(`${API_BASE}/generate_daily_routes.php?date=2025-12-01`);
                const data = await response.json();

                if (data.success) {
                    let summary = `üìä Routes Found: ${data.routes_generated}\n\n`;

                    if (data.routes && data.routes.length > 0) {
                        summary += `Route Details:\n`;
                        data.routes.forEach((route, i) => {
                            summary += `\n${i + 1}. ${route.name}\n`;
                            summary += `   - Barangays: ${route.barangays.join(', ')}\n`;
                            summary += `   - Stops: ${route.stops_count}\n`;
                        });
                    }

                    summary += `\n\nFull Response:\n${JSON.stringify(data, null, 2)}`;

                    resultDiv.className = 'success';
                    resultDiv.textContent = summary;
                } else {
                    resultDiv.className = 'error';
                    resultDiv.textContent = '‚ùå ERROR:\n\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.textContent = '‚ùå ERROR:\n\n' + error.message;
            }
        }
    </script>
</body>

</html>